---
- hosts: bootstrap
  user: root
  tasks:
  - name: Disable SSH password login
    lineinfile: >
      dest=/etc/ssh/sshd_config
      regexp="^PasswordAuthentication"
      line="PasswordAuthentication no"
      state=present
  - name: Disable SSH root login
    lineinfile: >
      dest=/etc/ssh/sshd_config
      regexp="^PermitRootLogin"
      line="PermitRootLogin no"
      state=present
  - name: Restart the SSH daemon
    service: name=sshd state=restarted
  - name: Add the deploy user
    user: name=deploy state=present group=wheel
  - name: Create the .ssh directory
    file: path=/home/deploy/.ssh state=directory owner=deploy mode=0700
  - name: Copy the authorized keys file
    copy: src=files/common/ssh/authorized_keys dest=/home/deploy/.ssh/authorized_keys mode=0600 owner=deploy
  - name: Set NOPASSWD for deploy on sudo
    lineinfile: >
      dest=/etc/sudoers
      insertafter=EOF
      line="deploy ALL=(ALL) NOPASSWD: ALL"
      regexp="deploy ALL=(ALL) NOPASSWD: ALL"
      state=present
  - name: Set the machine hostname
    hostname: name="{{inventory_hostname}}"
  - name: Install and enable the EPEL repo
    command: rpm -Uvh --replacepkgs https://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-2.noarch.rpm
